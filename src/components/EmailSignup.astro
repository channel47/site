---
/**
 * EmailSignup — email capture with editorial restraint.
 * Contained input + submit button. JS handles states.
 */
interface Props {
  placeholder?: string;
  tag?: string;
  submitText?: string;
  class?: string;
  variant?: 'default' | 'prominent';
}

const {
  placeholder = 'your@email.com',
  tag = 'general',
  submitText = 'Get access',
  class: className = '',
  variant = 'default'
} = Astro.props;

const formId = `email-signup-${Math.random().toString(36).substr(2, 9)}`;
const isProminent = variant === 'prominent';
---

<form
  id={formId}
  class:list={[
    'email-signup flex flex-col gap-3 w-full',
    isProminent ? 'max-w-[560px]' : 'max-w-[520px]',
    'sm:flex-row sm:items-stretch',
    className
  ]}
  data-signup-form
  data-tag={tag}
>
  <div class="w-full">
    <label for={`${formId}-email`} class="sr-only">Email address</label>
    <input
      type="email"
      id={`${formId}-email`}
      name="email"
      placeholder={placeholder}
      required
      class:list={[
        'email-signup__input w-full px-4 font-mono text-gray-700 bg-gray-100/80 border border-gray-300 rounded-md outline-none transition-all duration-100',
        'placeholder:text-gray-500 hover:border-gray-400 focus:border-amber focus:bg-gray-50 focus:shadow-[0_0_0_4px_rgba(245,158,11,0.2)]',
        isProminent ? 'h-[52px] text-base' : 'h-12 text-sm'
      ]}
      autocomplete="email"
      style="font-size: max(16px, inherit);"
    />
  </div>
  <button
    type="submit"
    class:list={[
      'email-signup__submit flex items-center justify-center gap-2 w-full sm:w-auto sm:shrink-0 px-5 font-mono text-[11px] font-semibold uppercase tracking-[0.12em] text-gray-0 bg-amber border-none rounded-md cursor-pointer whitespace-nowrap transition-all duration-100',
      'hover:bg-gray-700 hover:text-gray-0 active:scale-[0.97] focus-visible:outline-2 focus-visible:outline-gray-700 focus-visible:outline-offset-2 disabled:opacity-70 disabled:cursor-default',
      isProminent ? 'h-[52px]' : 'h-12'
    ]}
    aria-label="Subscribe"
  >
    <span class="email-signup__submit-text">{submitText}</span>
    <span class="email-signup__submit-icons relative w-4 h-4 shrink-0">
      <svg class="email-signup__icon email-signup__icon--arrow absolute inset-0 w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M5 12h14M12 5l7 7-7 7"/>
      </svg>
      <svg class="email-signup__icon email-signup__icon--check absolute inset-0 w-4 h-4 opacity-0 scale-[0.8]" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M5 12l5 5L20 7"/>
      </svg>
      <svg class="email-signup__icon email-signup__icon--loading absolute inset-0 w-4 h-4 opacity-0 scale-[0.8]" viewBox="0 0 24 24" fill="none">
        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" opacity="0.25"/>
        <path d="M12 2a10 10 0 0 1 10 10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </span>
  </button>
</form>

<script>
  function initEmailSignup() {
    const forms = document.querySelectorAll('[data-signup-form]');
    const EMAIL_REGEX = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

    function validateEmail(email: string): boolean {
      if (!email || email.length > 254) return false;
      return EMAIL_REGEX.test(email.trim());
    }

    forms.forEach((form) => {
      if (form.hasAttribute('data-initialized')) return;
      form.setAttribute('data-initialized', 'true');

      const formElement = form as HTMLFormElement;
      const emailInput = formElement.querySelector('input[name="email"]') as HTMLInputElement;
      const originalPlaceholder = emailInput.placeholder;

      emailInput.addEventListener('blur', () => {
        const email = emailInput.value.trim();
        if (email && !validateEmail(email)) {
          formElement.classList.add('is-error');
        } else {
          formElement.classList.remove('is-error');
        }
      });

      emailInput.addEventListener('input', () => {
        formElement.classList.remove('is-error');
        if (emailInput.placeholder !== originalPlaceholder) {
          emailInput.placeholder = originalPlaceholder;
        }
      });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const submitButton = formElement.querySelector('.email-signup__submit') as HTMLButtonElement;
        const tag = formElement.dataset.tag;
        const fieldsRaw = formElement.dataset.fields;
        const fields = fieldsRaw ? JSON.parse(fieldsRaw) : undefined;
        const email = emailInput.value.trim();

        if (!validateEmail(email)) {
          formElement.classList.add('is-error');
          emailInput.focus();
          return;
        }

        submitButton.disabled = true;
        formElement.classList.remove('is-error', 'is-success');
        formElement.classList.add('is-loading');

        try {
          const response = await fetch('/api/subscribe', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, tag: tag || 'general', fields }),
          });

          const data = await response.json();

          if (response.ok) {
            formElement.classList.remove('is-loading');
            formElement.classList.add('is-success');
            emailInput.value = '';

            setTimeout(() => {
              formElement.classList.remove('is-success');
            }, 2500);
          } else {
            formElement.classList.remove('is-loading');
            formElement.classList.add('is-server-error');
            emailInput.placeholder = data.message || 'Try again';

            setTimeout(() => {
              formElement.classList.remove('is-server-error');
            }, 2000);
          }
        } catch {
          formElement.classList.remove('is-loading');
          formElement.classList.add('is-server-error');
          emailInput.placeholder = 'Try again';

          setTimeout(() => {
            formElement.classList.remove('is-server-error');
          }, 2000);
        } finally {
          submitButton.disabled = false;
        }
      });
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initEmailSignup);
  } else {
    initEmailSignup();
  }

  document.addEventListener('astro:page-load', initEmailSignup);
</script>

<style>
  /* JS-driven state styles only — base layout is Tailwind */
  .email-signup__icon {
    transition: opacity 100ms var(--ease-signature), transform 100ms var(--ease-signature);
  }

  /* Loading */
  .email-signup.is-loading .email-signup__submit-text { opacity: 0.6; }
  .email-signup.is-loading .email-signup__icon--arrow { opacity: 0; transform: scale(0.8); }
  .email-signup.is-loading .email-signup__icon--loading { opacity: 1; transform: scale(1); animation: spin 1s linear infinite; }

  /* Success */
  .email-signup.is-success .email-signup__icon--arrow { opacity: 0; transform: scale(0.8); }
  .email-signup.is-success .email-signup__icon--check { opacity: 1; transform: scale(1); }
  .email-signup.is-success .email-signup__submit { background: #22c55e; }
  .email-signup.is-success .email-signup__input { border-color: #22c55e; }

  /* Error */
  .email-signup.is-error .email-signup__input { border-color: #ef4444; animation: error-shake 0.3s var(--ease-signature); }
  .email-signup.is-error .email-signup__input::placeholder { color: #ef4444; }

  /* Server error */
  .email-signup.is-server-error .email-signup__input { border-color: #ef4444; }
  .email-signup.is-server-error .email-signup__input::placeholder { color: #ef4444; }
</style>
