---
/**
 * EmailSignup Component
 *
 * Minimal inline email capture with embedded submit icon.
 * Arrow transforms to checkmark on success â€” quiet until earned.
 */

interface Props {
  placeholder?: string;
  tag?: string;
  class?: string;
}

const {
  placeholder = 'you@example.com',
  tag = 'general',
  class: className = ''
} = Astro.props;

const formId = `email-signup-${Math.random().toString(36).substr(2, 9)}`;
---

<form
  id={formId}
  class:list={['email-signup', className]}
  data-signup-form
  data-tag={tag}
>
  <div class="email-signup__field">
    <label for={`${formId}-email`} class="visually-hidden">Email address</label>
    <input
      type="email"
      id={`${formId}-email`}
      name="email"
      placeholder={placeholder}
      required
      class="email-signup__input"
      autocomplete="email"
    />
    <button type="submit" class="email-signup__submit" aria-label="Subscribe">
      <!-- Arrow icon (default state) -->
      <svg class="email-signup__icon email-signup__icon--arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M5 12h14M12 5l7 7-7 7"/>
      </svg>
      <!-- Checkmark icon (success state) -->
      <svg class="email-signup__icon email-signup__icon--check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M5 12l5 5L20 7"/>
      </svg>
      <!-- Loading spinner -->
      <svg class="email-signup__icon email-signup__icon--loading" viewBox="0 0 24 24" fill="none">
        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" opacity="0.25"/>
        <path d="M12 2a10 10 0 0 1 10 10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </button>
  </div>
</form>

<script>
  function initEmailSignup() {
    const forms = document.querySelectorAll('[data-signup-form]');
    const EMAIL_REGEX = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

    function validateEmail(email: string): boolean {
      if (!email || email.length > 254) return false;
      return EMAIL_REGEX.test(email.trim());
    }

    forms.forEach((form) => {
      if (form.hasAttribute('data-initialized')) return;
      form.setAttribute('data-initialized', 'true');

      const formElement = form as HTMLFormElement;
      const emailInput = formElement.querySelector('input[name="email"]') as HTMLInputElement;
      const originalPlaceholder = emailInput.placeholder;

      // Validation on blur
      emailInput.addEventListener('blur', () => {
        const email = emailInput.value.trim();
        if (email && !validateEmail(email)) {
          formElement.classList.add('is-error');
        } else {
          formElement.classList.remove('is-error');
        }
      });

      // Clear error on input
      emailInput.addEventListener('input', () => {
        formElement.classList.remove('is-error');
        // Reset placeholder if it was changed to error message
        if (emailInput.placeholder !== originalPlaceholder) {
          emailInput.placeholder = originalPlaceholder;
        }
      });

      // Form submission
      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const submitButton = formElement.querySelector('.email-signup__submit') as HTMLButtonElement;
        const tag = formElement.dataset.tag;
        const email = emailInput.value.trim();

        // Client-side validation
        if (!validateEmail(email)) {
          formElement.classList.add('is-error');
          emailInput.focus();
          return;
        }

        // Start loading state
        submitButton.disabled = true;
        formElement.classList.remove('is-error', 'is-success');
        formElement.classList.add('is-loading');

        try {
          const response = await fetch('/api/subscribe', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, tag: tag || 'general' }),
          });

          const data = await response.json();

          if (response.ok) {
            // Success: show checkmark, clear input
            formElement.classList.remove('is-loading');
            formElement.classList.add('is-success');
            emailInput.value = '';

            // Revert to arrow after 2.5 seconds
            setTimeout(() => {
              formElement.classList.remove('is-success');
            }, 2500);
          } else {
            // Error: flash border, update placeholder
            formElement.classList.remove('is-loading');
            formElement.classList.add('is-error');
            emailInput.placeholder = data.message || 'Something went wrong. Try again.';

            // Reset error state after animation
            setTimeout(() => {
              formElement.classList.remove('is-error');
            }, 2000);
          }
        } catch (error) {
          formElement.classList.remove('is-loading');
          formElement.classList.add('is-error');
          emailInput.placeholder = 'Something went wrong. Try again.';

          setTimeout(() => {
            formElement.classList.remove('is-error');
          }, 2000);
        } finally {
          submitButton.disabled = false;
        }
      });
    });
  }

  // Run on initial load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initEmailSignup);
  } else {
    initEmailSignup();
  }

  // Also run on Astro view transitions
  document.addEventListener('astro:page-load', initEmailSignup);
</script>

<style>
  .email-signup {
    width: 100%;
    max-width: 520px;
  }

  /* Field container - input with embedded button */
  .email-signup__field {
    position: relative;
    display: flex;
    align-items: center;
  }

  /* Input - takes full width, padding-right for button */
  .email-signup__input {
    width: 100%;
    height: var(--input-height);
    padding: 0 var(--space-12) 0 var(--input-padding-x);
    font-family: var(--font-sans);
    font-size: var(--text-sm);
    color: var(--color-fg);
    background: var(--color-bg-elevated);
    border: var(--border-thin) solid var(--color-border);
    border-radius: var(--radius-lg);
    outline: none;
    -webkit-tap-highlight-color: transparent;
    transition:
      border-color var(--duration-fast) var(--ease-out),
      box-shadow var(--duration-fast) var(--ease-out),
      background-color var(--duration-fast) var(--ease-out);
  }

  .email-signup__input::placeholder {
    color: var(--color-fg-muted);
    transition: color var(--duration-fast) var(--ease-out);
  }

  .email-signup__input:hover {
    border-color: var(--color-border-hover);
    background-color: var(--color-bg-surface);
  }

  .email-signup__input:focus {
    border-color: var(--color-fg-muted);
    background-color: var(--color-bg-elevated);
  }

  /* Submit button - positioned inside input */
  .email-signup__submit {
    position: absolute;
    right: var(--space-1);
    top: 50%;
    transform: translateY(-50%);
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
    color: var(--color-fg-muted);
    -webkit-tap-highlight-color: transparent;
    transition:
      color var(--duration-fast) var(--ease-out),
      background-color var(--duration-fast) var(--ease-out);
  }

  .email-signup__submit:hover {
    color: var(--color-fg-secondary);
    background-color: var(--color-bg-surface);
  }

  .email-signup__submit:focus-visible {
    outline: 2px solid var(--color-fg-muted);
    outline-offset: -2px;
  }

  .email-signup__submit:disabled {
    cursor: default;
  }

  /* Icons */
  .email-signup__icon {
    width: 18px;
    height: 18px;
    position: absolute;
    transition:
      opacity 0.3s var(--ease-out),
      transform 0.3s var(--ease-out);
  }

  .email-signup__icon--arrow {
    opacity: 1;
    transform: scale(1);
  }

  .email-signup__icon--check {
    opacity: 0;
    transform: scale(0.8);
  }

  .email-signup__icon--loading {
    opacity: 0;
    transform: scale(0.8);
  }

  /* Loading state */
  .email-signup.is-loading .email-signup__icon--arrow {
    opacity: 0;
    transform: scale(0.8);
  }

  .email-signup.is-loading .email-signup__icon--loading {
    opacity: 1;
    transform: scale(1);
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: scale(1) rotate(360deg); }
  }

  /* Success state - checkmark earns the color */
  .email-signup.is-success .email-signup__icon--arrow {
    opacity: 0;
    transform: scale(0.8);
  }

  .email-signup.is-success .email-signup__icon--check {
    opacity: 1;
    transform: scale(1);
    color: var(--color-accent);
  }

  .email-signup.is-success .email-signup__submit {
    color: var(--color-accent);
  }

  .email-signup.is-success .email-signup__input {
    box-shadow: 0 0 0 1px var(--color-accent-subtle), 0 0 12px var(--color-accent-subtle);
    animation: success-glow 0.6s var(--ease-out);
  }

  @keyframes success-glow {
    0% {
      box-shadow: 0 0 0 1px var(--color-accent-subtle), 0 0 0px var(--color-accent-subtle);
    }
    50% {
      box-shadow: 0 0 0 1px var(--color-accent-subtle), 0 0 20px var(--color-accent-subtle);
    }
    100% {
      box-shadow: 0 0 0 1px var(--color-accent-subtle), 0 0 12px var(--color-accent-subtle);
    }
  }

  /* Error state */
  .email-signup.is-error .email-signup__input {
    border-color: var(--color-error);
    animation: error-shake 0.4s var(--ease-out);
  }

  .email-signup.is-error .email-signup__input::placeholder {
    color: var(--color-error);
  }

  @keyframes error-shake {
    0%, 100% { transform: translateX(0); }
    20% { transform: translateX(-4px); }
    40% { transform: translateX(4px); }
    60% { transform: translateX(-2px); }
    80% { transform: translateX(2px); }
  }

  /* Accessibility */
  .visually-hidden {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .email-signup__input,
    .email-signup__submit,
    .email-signup__icon {
      transition: none;
    }

    .email-signup__icon--loading {
      animation: none;
    }

    .email-signup.is-success .email-signup__input {
      animation: none;
    }

    .email-signup.is-error .email-signup__input {
      animation: none;
    }
  }
</style>
