---
/**
 * EmailSignup Component
 *
 * Minimal single-line email capture.
 * Just an underline and an arrow â€” editorial simplicity.
 */

interface Props {
  placeholder?: string;
  tag?: string;
  class?: string;
}

const {
  placeholder = 'your@email.com',
  tag = 'general',
  class: className = ''
} = Astro.props;

const formId = `email-signup-${Math.random().toString(36).substr(2, 9)}`;
---

<form
  id={formId}
  class:list={['email-signup', className]}
  data-signup-form
  data-tag={tag}
>
  <label for={`${formId}-email`} class="visually-hidden">Email address</label>
  <input
    type="email"
    id={`${formId}-email`}
    name="email"
    placeholder={placeholder}
    required
    class="email-signup__input"
    autocomplete="email"
  />
  <button type="submit" class="email-signup__submit" aria-label="Subscribe">
    <svg class="email-signup__icon email-signup__icon--arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <path d="M5 12h14M12 5l7 7-7 7"/>
    </svg>
    <svg class="email-signup__icon email-signup__icon--check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M5 12l5 5L20 7"/>
    </svg>
    <svg class="email-signup__icon email-signup__icon--loading" viewBox="0 0 24 24" fill="none">
      <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" opacity="0.25"/>
      <path d="M12 2a10 10 0 0 1 10 10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
    </svg>
  </button>
</form>

<script>
  function initEmailSignup() {
    const forms = document.querySelectorAll('[data-signup-form]');
    const EMAIL_REGEX = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

    function validateEmail(email: string): boolean {
      if (!email || email.length > 254) return false;
      return EMAIL_REGEX.test(email.trim());
    }

    forms.forEach((form) => {
      if (form.hasAttribute('data-initialized')) return;
      form.setAttribute('data-initialized', 'true');

      const formElement = form as HTMLFormElement;
      const emailInput = formElement.querySelector('input[name="email"]') as HTMLInputElement;
      const originalPlaceholder = emailInput.placeholder;

      emailInput.addEventListener('blur', () => {
        const email = emailInput.value.trim();
        if (email && !validateEmail(email)) {
          formElement.classList.add('is-error');
        } else {
          formElement.classList.remove('is-error');
        }
      });

      emailInput.addEventListener('input', () => {
        formElement.classList.remove('is-error');
        if (emailInput.placeholder !== originalPlaceholder) {
          emailInput.placeholder = originalPlaceholder;
        }
      });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const submitButton = formElement.querySelector('.email-signup__submit') as HTMLButtonElement;
        const tag = formElement.dataset.tag;
        const email = emailInput.value.trim();

        if (!validateEmail(email)) {
          formElement.classList.add('is-error');
          emailInput.focus();
          return;
        }

        submitButton.disabled = true;
        formElement.classList.remove('is-error', 'is-success');
        formElement.classList.add('is-loading');

        try {
          const response = await fetch('/api/subscribe', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, tag: tag || 'general' }),
          });

          const data = await response.json();

          if (response.ok) {
            formElement.classList.remove('is-loading');
            formElement.classList.add('is-success');
            emailInput.value = '';

            setTimeout(() => {
              formElement.classList.remove('is-success');
            }, 2500);
          } else {
            formElement.classList.remove('is-loading');
            formElement.classList.add('is-error');
            emailInput.placeholder = data.message || 'Try again';

            setTimeout(() => {
              formElement.classList.remove('is-error');
            }, 2000);
          }
        } catch (error) {
          formElement.classList.remove('is-loading');
          formElement.classList.add('is-error');
          emailInput.placeholder = 'Try again';

          setTimeout(() => {
            formElement.classList.remove('is-error');
          }, 2000);
        } finally {
          submitButton.disabled = false;
        }
      });
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initEmailSignup);
  } else {
    initEmailSignup();
  }

  document.addEventListener('astro:page-load', initEmailSignup);
</script>

<style>
  .email-signup {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    max-width: 320px;
  }

  .email-signup__input {
    flex: 1;
    min-width: 0;
    padding: var(--space-2) 0;
    font-family: var(--font-sans);
    font-size: var(--text-base);
    color: var(--color-fg);
    background: transparent;
    border: none;
    border-bottom: 1px solid var(--color-border);
    border-radius: 0;
    outline: none;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    transition:
      border-color var(--duration-fast) var(--ease-out),
      color var(--duration-fast) var(--ease-out);
  }

  @media (min-width: 768px) {
    .email-signup__input {
      font-size: var(--text-sm);
    }
  }

  .email-signup__input::placeholder {
    color: var(--color-fg-subtle);
  }

  .email-signup__input:hover {
    border-color: var(--color-border-hover);
  }

  .email-signup__input:focus {
    border-color: var(--color-fg-muted);
  }

  .email-signup__submit {
    flex-shrink: 0;
    width: 24px;
    height: 24px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: none;
    cursor: pointer;
    color: var(--color-fg-subtle);
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    position: relative;
    transition: color var(--duration-fast) var(--ease-out);
  }

  .email-signup__submit:hover {
    color: var(--color-fg-secondary);
  }

  .email-signup__submit:active {
    transform: scale(0.95);
  }

  .email-signup__submit:focus-visible {
    outline: 2px solid var(--color-fg-muted);
    outline-offset: 2px;
  }

  .email-signup__submit:disabled {
    cursor: default;
  }

  .email-signup__icon {
    width: 18px;
    height: 18px;
    position: absolute;
    transition:
      opacity 0.2s var(--ease-out),
      transform 0.2s var(--ease-out);
  }

  .email-signup__icon--arrow {
    opacity: 1;
  }

  .email-signup__icon--check,
  .email-signup__icon--loading {
    opacity: 0;
    transform: scale(0.8);
  }

  /* Loading */
  .email-signup.is-loading .email-signup__icon--arrow {
    opacity: 0;
    transform: scale(0.8);
  }

  .email-signup.is-loading .email-signup__icon--loading {
    opacity: 1;
    transform: scale(1);
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Success */
  .email-signup.is-success .email-signup__icon--arrow {
    opacity: 0;
    transform: scale(0.8);
  }

  .email-signup.is-success .email-signup__icon--check {
    opacity: 1;
    transform: scale(1);
  }

  .email-signup.is-success .email-signup__submit {
    color: var(--color-accent);
  }

  .email-signup.is-success .email-signup__input {
    border-color: var(--color-accent);
  }

  /* Error */
  .email-signup.is-error .email-signup__input {
    border-color: var(--color-error);
    animation: error-shake 0.3s var(--ease-out);
  }

  .email-signup.is-error .email-signup__input::placeholder {
    color: var(--color-error);
  }

  @keyframes error-shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-3px); }
    75% { transform: translateX(3px); }
  }

  .visually-hidden {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  @media (prefers-reduced-motion: reduce) {
    .email-signup__input,
    .email-signup__submit,
    .email-signup__icon {
      transition: none;
    }

    .email-signup__icon--loading {
      animation: none;
    }

    .email-signup.is-error .email-signup__input {
      animation: none;
    }
  }
</style>
