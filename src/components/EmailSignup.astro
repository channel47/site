---
/**
 * EmailSignup Component
 *
 * Premium email capture with editorial restraint.
 * Contained input with warm accent, satisfying submit button.
 *
 * Design: Typography-forward with subtle depth.
 * Interaction: Confident focus states, rewarding feedback.
 */

interface Props {
  placeholder?: string;
  tag?: string;
  class?: string;
  /** Visual variant: 'default' or 'prominent' for hero placement */
  variant?: 'default' | 'prominent';
}

const {
  placeholder = 'your@email.com',
  tag = 'general',
  class: className = '',
  variant = 'default'
} = Astro.props;

const formId = `email-signup-${Math.random().toString(36).substr(2, 9)}`;
---

<form
  id={formId}
  class:list={['email-signup', `email-signup--${variant}`, className]}
  data-signup-form
  data-tag={tag}
>
  <div class="email-signup__field">
    <label for={`${formId}-email`} class="visually-hidden">Email address</label>
    <input
      type="email"
      id={`${formId}-email`}
      name="email"
      placeholder={placeholder}
      required
      class="email-signup__input"
      autocomplete="email"
    />
  </div>
  <button type="submit" class="email-signup__submit" aria-label="Subscribe">
    <span class="email-signup__submit-text">Get access</span>
    <span class="email-signup__submit-icons">
      <svg class="email-signup__icon email-signup__icon--arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M5 12h14M12 5l7 7-7 7"/>
      </svg>
      <svg class="email-signup__icon email-signup__icon--check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M5 12l5 5L20 7"/>
      </svg>
      <svg class="email-signup__icon email-signup__icon--loading" viewBox="0 0 24 24" fill="none">
        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" opacity="0.25"/>
        <path d="M12 2a10 10 0 0 1 10 10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </span>
  </button>
</form>

<script>
  function initEmailSignup() {
    const forms = document.querySelectorAll('[data-signup-form]');
    const EMAIL_REGEX = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

    function validateEmail(email: string): boolean {
      if (!email || email.length > 254) return false;
      return EMAIL_REGEX.test(email.trim());
    }

    forms.forEach((form) => {
      if (form.hasAttribute('data-initialized')) return;
      form.setAttribute('data-initialized', 'true');

      const formElement = form as HTMLFormElement;
      const emailInput = formElement.querySelector('input[name="email"]') as HTMLInputElement;
      const originalPlaceholder = emailInput.placeholder;

      emailInput.addEventListener('blur', () => {
        const email = emailInput.value.trim();
        if (email && !validateEmail(email)) {
          formElement.classList.add('is-error');
        } else {
          formElement.classList.remove('is-error');
        }
      });

      emailInput.addEventListener('input', () => {
        formElement.classList.remove('is-error');
        if (emailInput.placeholder !== originalPlaceholder) {
          emailInput.placeholder = originalPlaceholder;
        }
      });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const submitButton = formElement.querySelector('.email-signup__submit') as HTMLButtonElement;
        const tag = formElement.dataset.tag;
        const email = emailInput.value.trim();

        if (!validateEmail(email)) {
          formElement.classList.add('is-error');
          emailInput.focus();
          return;
        }

        submitButton.disabled = true;
        formElement.classList.remove('is-error', 'is-success');
        formElement.classList.add('is-loading');

        try {
          const response = await fetch('/api/subscribe', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, tag: tag || 'general' }),
          });

          const data = await response.json();

          if (response.ok) {
            formElement.classList.remove('is-loading');
            formElement.classList.add('is-success');
            emailInput.value = '';

            setTimeout(() => {
              formElement.classList.remove('is-success');
            }, 2500);
          } else {
            formElement.classList.remove('is-loading');
            formElement.classList.add('is-server-error');
            emailInput.placeholder = data.message || 'Try again';

            setTimeout(() => {
              formElement.classList.remove('is-server-error');
            }, 2000);
          }
        } catch (error) {
          formElement.classList.remove('is-loading');
          formElement.classList.add('is-server-error');
          emailInput.placeholder = 'Try again';

          setTimeout(() => {
            formElement.classList.remove('is-server-error');
          }, 2000);
        } finally {
          submitButton.disabled = false;
        }
      });
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initEmailSignup);
  } else {
    initEmailSignup();
  }

  document.addEventListener('astro:page-load', initEmailSignup);
</script>

<style>
  /* =========================================
   * EMAIL SIGNUP - Restrained Editorial CTA
   *
   * Design: Stacked layout, matching widths,
   * quiet confidence without shouting.
   * ========================================= */

  .email-signup {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
    width: 100%;
    max-width: 320px;
  }

  /* Input field container */
  .email-signup__field {
    width: 100%;
  }

  .email-signup__input {
    width: 100%;
    height: 44px;
    padding: 0 var(--space-4);
    font-family: var(--font-sans);
    /* 16px minimum prevents iOS auto-zoom on focus */
    font-size: max(16px, var(--text-sm));
    color: var(--color-fg);
    background: var(--color-bg-elevated);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    outline: none;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    transition:
      border-color var(--duration-fast) var(--ease-out),
      background-color var(--duration-fast) var(--ease-out);
  }

  .email-signup__input::placeholder {
    color: var(--color-fg-subtle);
  }

  .email-signup__input:hover {
    border-color: var(--color-border-hover);
  }

  .email-signup__input:focus {
    border-color: var(--color-accent);
    background: var(--color-bg-surface);
  }

  /* Submit button - full width to match input */
  .email-signup__submit {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    width: 100%;
    height: 44px;
    padding: 0 var(--space-5);
    font-family: var(--font-sans);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    letter-spacing: var(--tracking-wide);
    color: var(--color-fg-inverse);
    background: var(--color-accent);
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
    white-space: nowrap;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    transition:
      background-color var(--duration-fast) var(--ease-out),
      transform var(--duration-fast) var(--ease-out);
  }

  .email-signup__submit:hover {
    background: var(--color-accent-hover);
  }

  .email-signup__submit:active {
    transform: scale(0.98);
    background: var(--color-accent-active);
  }

  .email-signup__submit:focus-visible {
    outline: 2px solid var(--color-fg);
    outline-offset: 2px;
  }

  .email-signup__submit:disabled {
    cursor: default;
    opacity: 0.7;
  }

  /* Button text and icons container */
  .email-signup__submit-text {
    transition: opacity var(--duration-fast) var(--ease-out);
  }

  .email-signup__submit-icons {
    position: relative;
    width: 16px;
    height: 16px;
    flex-shrink: 0;
  }

  .email-signup__icon {
    width: 16px;
    height: 16px;
    position: absolute;
    top: 0;
    left: 0;
    transition:
      opacity var(--duration-fast) var(--ease-out),
      transform var(--duration-fast) var(--ease-out);
  }

  .email-signup__icon--arrow {
    opacity: 1;
  }

  .email-signup__icon--check,
  .email-signup__icon--loading {
    opacity: 0;
    transform: scale(0.8);
  }

  /* Loading state */
  .email-signup.is-loading .email-signup__submit-text {
    opacity: 0.6;
  }

  .email-signup.is-loading .email-signup__icon--arrow {
    opacity: 0;
    transform: scale(0.8);
  }

  .email-signup.is-loading .email-signup__icon--loading {
    opacity: 1;
    transform: scale(1);
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Arc spinner animation */
  .email-signup__icon--loading path {
    stroke-dasharray: 45;
    stroke-dashoffset: 45;
    animation: spinner-arc 1s var(--ease-out) infinite;
  }

  @keyframes spinner-arc {
    0% {
      stroke-dashoffset: 45;
      transform: rotate(0deg);
    }
    50% {
      stroke-dashoffset: 15;
    }
    100% {
      stroke-dashoffset: 45;
      transform: rotate(360deg);
    }
  }

  /* Success state */
  .email-signup.is-success .email-signup__icon--arrow {
    opacity: 0;
    transform: scale(0.8);
  }

  .email-signup.is-success .email-signup__icon--check {
    opacity: 1;
    transform: scale(1);
  }

  .email-signup.is-success .email-signup__submit {
    background: var(--color-success);
  }

  .email-signup.is-success .email-signup__input {
    border-color: var(--color-success);
  }

  /* Touch feedback for mobile */
  @media (hover: none) {
    .email-signup__submit:active {
      transform: scale(0.97);
    }
  }

  /* Error state */
  .email-signup.is-error .email-signup__input {
    border-color: var(--color-error);
    animation: error-shake 0.3s var(--ease-out);
  }

  .email-signup.is-error .email-signup__input::placeholder {
    color: var(--color-error);
  }

  @keyframes error-shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-3px); }
    75% { transform: translateX(3px); }
  }

  /* Server error - gentler pulse */
  .email-signup.is-server-error .email-signup__input {
    border-color: var(--color-error);
    animation: error-pulse 0.4s var(--ease-out);
  }

  .email-signup.is-server-error .email-signup__input::placeholder {
    color: var(--color-error);
  }

  @keyframes error-pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
  }

  /* =========================================
   * PROMINENT VARIANT
   * Slightly larger for hero - same stacked layout
   * ========================================= */
  .email-signup--prominent {
    max-width: 340px;
  }

  .email-signup--prominent .email-signup__input,
  .email-signup--prominent .email-signup__submit {
    height: 48px;
  }

  .email-signup--prominent .email-signup__input {
    font-size: max(16px, var(--text-base));
  }

  /* Accessibility */
  .visually-hidden {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  @media (prefers-reduced-motion: reduce) {
    .email-signup__input,
    .email-signup__submit,
    .email-signup__icon,
    .email-signup__submit-text {
      transition: none;
    }

    .email-signup__icon--loading,
    .email-signup__icon--loading path {
      animation: none;
    }

    .email-signup.is-error .email-signup__input,
    .email-signup.is-server-error .email-signup__input {
      animation: none;
    }
  }
</style>
