---
/**
 * Homepage — Newsletter landing page with tool list as proof-of-work.
 *
 * Structure: Hero (headline + email) → Search → Tool cards → Footer
 */
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import Nav from '../components/Nav.astro';
import Footer from '../components/Footer.astro';
import EmailSignup from '../components/EmailSignup.astro';
import ToolCard from '../components/ToolCard.astro';
import PaidBriefsCard from '../components/PaidBriefsCard.astro';

const allTools = await getCollection('tools');
const toolCount = allTools.length;

// Insert Paid Briefs card roughly mid-list
const midpoint = Math.floor(allTools.length / 2);

const schema = [
  {
    '@type': 'Organization',
    'name': 'Channel 47',
    'url': 'https://channel47.dev',
    'logo': 'https://channel47.dev/og-image.png',
    'description': 'AI tools built from real work. Skills, MCP servers, and plugins for Claude Code.',
    'founder': {
      '@type': 'Person',
      'name': 'Jackson Dean',
      'url': 'https://x.com/ctrlswing',
    },
    'sameAs': [
      'https://github.com/channel47',
      'https://x.com/ctrlswing',
      'https://github.com/ctrlswing',
      'https://www.linkedin.com/in/jackson-d-9979a7a0/',
    ],
  },
  {
    '@type': 'WebSite',
    'name': 'Channel 47',
    'url': 'https://channel47.dev',
  },
];
---

<BaseLayout
  title="Channel 47 — AI Tools Built from Real Work"
  description="New tools and breakdowns every week. Skills, MCP servers, and plugins for Claude Code. Subscribe to Build Notes."
  schema={schema}
>
  <Nav />

  <main id="main-content">
    <!-- ═══════════════════════════════════════════
         HERO — Headline + email capture
         ═══════════════════════════════════════════ -->
    <section class="pt-32 pb-16 px-[clamp(24px,5vw,64px)]" data-section="hero">
      <div class="max-w-[1060px] mx-auto">
        <h1 class="font-heading text-[clamp(1.75rem,4vw,2.75rem)] font-semibold tracking-tight leading-[1.1] mb-3" style="font-family: var(--font-family-heading);">
          <span class="text-primary">AI tools</span>
          <span class="text-gray-600"> built from real work.</span>
        </h1>
        <p class="font-mono text-sm text-gray-600 leading-relaxed tracking-wide max-w-[520px] mb-8">
          New tools and breakdowns every week. Subscribe to Build Notes.
        </p>
        <EmailSignup placeholder="you@domain.com" tag="home" submitText="Subscribe" />
      </div>
    </section>

    <!-- ═══════════════════════════════════════════
         SEARCH + TOOL LIST — Proof of work
         ═══════════════════════════════════════════ -->
    <section class="px-[clamp(24px,5vw,64px)] pb-16" data-animate="fade-up">
      <div class="max-w-[1060px] mx-auto">
        <div class="border-t border-gray-200 pt-8 mb-6">
          <label for="tool-search" class="sr-only">Search tools</label>
          <input
            type="text"
            id="tool-search"
            placeholder="Search tools..."
            class="w-full px-4 h-12 font-mono text-sm text-gray-700 bg-gray-50 border border-gray-300 rounded-md outline-none transition-[border-color,box-shadow] duration-100 placeholder:text-gray-500 hover:border-gray-400 focus-visible:border-amber focus-visible:shadow-[0_0_0_4px_rgba(245,158,11,0.2)]"
            autocomplete="off"
            spellcheck="false"
          />
        </div>

        <p class="font-mono text-[11px] text-gray-500 mb-6">{toolCount} tools shipped</p>

        <div id="tool-list">
          {allTools.map((tool, i) => (
            <Fragment>
              {i === midpoint && <PaidBriefsCard />}
              <ToolCard
                name={tool.data.name}
                description={tool.data.description}
                type={tool.data.type}
                repo={tool.data.repo}
              />
            </Fragment>
          ))}
          {allTools.length <= midpoint && <PaidBriefsCard />}
        </div>

        <p id="no-results" class="font-mono text-sm text-gray-500 py-8 hidden">No tools match your search.</p>
      </div>
    </section>

    <Footer />
  </main>

  <script>
    import { initPageMotion } from '../scripts/page-motion';
    initPageMotion();
  </script>

  <!-- Search filter logic -->
  <script>
    function initSearch() {
      const input = document.getElementById('tool-search') as HTMLInputElement;
      const list = document.getElementById('tool-list');
      const noResults = document.getElementById('no-results');
      if (!input || !list) return;

      const cards = list.querySelectorAll('[data-name]');

      input.addEventListener('input', () => {
        const query = input.value.toLowerCase().trim();
        let visibleCount = 0;

        cards.forEach(card => {
          const name = card.getAttribute('data-name') || '';
          const desc = card.getAttribute('data-description') || '';
          const type = card.getAttribute('data-type') || '';
          const matches = !query || name.includes(query) || desc.includes(query) || type.includes(query);
          (card as HTMLElement).style.display = matches ? '' : 'none';
          if (matches) visibleCount++;
        });

        // Show/hide Paid Briefs card based on search
        const pbCard = list.querySelector('[data-type="product"]') as HTMLElement;
        if (pbCard) {
          const pbName = pbCard.getAttribute('data-name') || '';
          const pbDesc = pbCard.getAttribute('data-description') || '';
          const pbMatches = !query || pbName.includes(query) || pbDesc.includes(query) || 'product'.includes(query);
          pbCard.style.display = pbMatches ? '' : 'none';
          if (pbMatches) visibleCount++;
        }

        if (noResults) {
          noResults.classList.toggle('hidden', visibleCount > 0);
        }
      });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initSearch);
    } else {
      initSearch();
    }
    document.addEventListener('astro:page-load', initSearch);
  </script>
</BaseLayout>
