---
/**
 * Homepage — The marketing AI directory.
 *
 * Structure: Hero (headline + newsletter bar) → Filter tabs + Search → Tool list → Footer
 */
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import Nav from '../components/Nav.astro';
import Footer from '../components/Footer.astro';
import EmailSignup from '../components/EmailSignup.astro';
import ToolCard from '../components/ToolCard.astro';
import PaidBriefsCard from '../components/PaidBriefsCard.astro';

const allTools = await getCollection('tools');
const toolCount = allTools.length;

const midpoint = Math.floor(allTools.length / 2);

// Route prefixes: /skills/, /mcps/, /plugins/, /coming-soon
const typePrefix: Record<string, string> = {
  skill: 'skills',
  mcp: 'mcps',
  plugin: 'plugins',
  subagent: 'coming-soon',
};

function toolHref(tool: { id: string; data: { type: string } }) {
  if (tool.data.type === 'subagent') return '/coming-soon';
  const slug = tool.id.split('/').pop()?.replace(/\.md$/, '');
  return `/${typePrefix[tool.data.type]}/${slug}`;
}

const schema = [
  {
    '@type': 'Organization',
    'name': 'Channel 47',
    'url': 'https://channel47.dev',
    'logo': 'https://channel47.dev/og-image.png',
    'description': 'The marketing AI directory. Skills, MCPs, and plugins for marketing workflows.',
    'founder': {
      '@type': 'Person',
      'name': 'Jackson Dean',
      'url': 'https://x.com/ctrlswing',
    },
    'sameAs': [
      'https://github.com/channel47',
      'https://x.com/ctrlswing',
    ],
  },
  {
    '@type': 'WebSite',
    'name': 'Channel 47',
    'url': 'https://channel47.dev',
  },
];
---

<BaseLayout
  title="Channel 47 — The Marketing AI Directory"
  description="Skills, MCPs, and plugins for marketing workflows. New tools and breakdowns weekly."
  schema={schema}
>
  <Nav />

  <main id="main-content">
    <section class="pt-28 pb-6 px-[clamp(24px,5vw,64px)]" data-section="hero">
      <div class="max-w-[1060px] mx-auto">
        <h1 class="font-heading text-[clamp(1.5rem,3.5vw,2.25rem)] font-semibold tracking-tight leading-[1.1] text-primary mb-4" style="font-family: var(--font-family-heading);">
          The marketing AI directory.
        </h1>
        <div class="flex flex-col sm:flex-row sm:items-center gap-3 sm:gap-4">
          <p class="font-mono text-sm text-gray-600 tracking-wide shrink-0">New tools and breakdowns weekly.</p>
          <EmailSignup placeholder="you@domain.com" tag="home" submitText="Subscribe" class="max-w-[360px]" />
        </div>
      </div>
    </section>

    <section class="px-[clamp(24px,5vw,64px)] pb-12" data-animate="fade-up">
      <div class="max-w-[1060px] mx-auto">
        <div class="border-t border-gray-200 pt-6 mb-5">
          <div class="flex flex-col sm:flex-row sm:items-center gap-4 mb-5">
            <div id="filter-tabs" class="flex items-center gap-1" role="tablist" aria-label="Filter by type">
              <button class="filter-tab font-mono text-[11px] uppercase tracking-[0.1em] px-3 py-1.5 rounded-tight border border-transparent cursor-pointer transition-colors duration-100 text-gray-500 hover:text-primary" data-filter="all" role="tab" aria-selected="true">All</button>
              <button class="filter-tab font-mono text-[11px] uppercase tracking-[0.1em] px-3 py-1.5 rounded-tight border border-transparent cursor-pointer transition-colors duration-100 text-gray-500 hover:text-primary" data-filter="skill" role="tab" aria-selected="false">Skills</button>
              <button class="filter-tab font-mono text-[11px] uppercase tracking-[0.1em] px-3 py-1.5 rounded-tight border border-transparent cursor-pointer transition-colors duration-100 text-gray-500 hover:text-primary" data-filter="mcp" role="tab" aria-selected="false">MCPs</button>
              <button class="filter-tab font-mono text-[11px] uppercase tracking-[0.1em] px-3 py-1.5 rounded-tight border border-transparent cursor-pointer transition-colors duration-100 text-gray-500 hover:text-primary" data-filter="plugin" role="tab" aria-selected="false">Plugins</button>
            </div>
            <div class="flex-1">
              <label for="tool-search" class="sr-only">Search tools</label>
              <input
                type="text"
                id="tool-search"
                placeholder="Search tools..."
                class="w-full px-4 h-10 font-mono text-sm text-gray-700 bg-gray-100/80 border border-gray-300 rounded-tight outline-none transition-[border-color,box-shadow] duration-100 placeholder:text-gray-500 hover:border-gray-400 focus-visible:border-amber focus-visible:shadow-[0_0_0_4px_rgba(245,158,11,0.2)]"
                autocomplete="off"
                spellcheck="false"
              />
            </div>
          </div>
        </div>

        <p class="font-mono text-[11px] text-gray-500 mb-6"><span id="visible-count">{toolCount}</span> tools shipped</p>

        <div id="tool-list">
          {allTools.map((tool, i) => (
            <Fragment>
              {i === midpoint && <PaidBriefsCard />}
              <ToolCard
                name={tool.data.name}
                description={tool.data.description}
                type={tool.data.type}
                href={toolHref(tool)}
              />
            </Fragment>
          ))}
          {allTools.length <= midpoint && <PaidBriefsCard />}
        </div>

        <p id="no-results" class="font-mono text-sm text-gray-500 py-8 hidden">No tools match your search.</p>
      </div>
    </section>

    <Footer />
  </main>

  <script>
    import { initPageMotion } from '../scripts/page-motion';
    initPageMotion();
  </script>

  <script>
    function initDirectory() {
      const input = document.getElementById('tool-search') as HTMLInputElement;
      const list = document.getElementById('tool-list');
      const noResults = document.getElementById('no-results');
      const tabs = document.querySelectorAll('[data-filter]');
      const visibleCountEl = document.getElementById('visible-count');
      if (!input || !list) return;

      const cards = list.querySelectorAll('[data-name]');
      let activeFilter = 'all';

      function applyFilters() {
        const query = input.value.toLowerCase().trim();
        let visibleCount = 0;

        cards.forEach(card => {
          const name = card.getAttribute('data-name') || '';
          const desc = card.getAttribute('data-description') || '';
          const type = card.getAttribute('data-type') || '';

          const matchesFilter = activeFilter === 'all' || type === activeFilter;
          const matchesSearch = !query || name.includes(query) || desc.includes(query) || type.includes(query);
          const visible = matchesFilter && matchesSearch;

          (card as HTMLElement).style.display = visible ? '' : 'none';
          if (visible) visibleCount++;
        });

        // Show/hide PaidBriefs card based on filter
        const pbCard = list.querySelector('[data-type="product"]') as HTMLElement;
        if (pbCard) {
          const pbName = pbCard.getAttribute('data-name') || '';
          const pbDesc = pbCard.getAttribute('data-description') || '';
          const pbMatchesSearch = !query || pbName.includes(query) || pbDesc.includes(query) || 'product'.includes(query);
          const pbVisible = activeFilter === 'all' && pbMatchesSearch;
          pbCard.style.display = pbVisible ? '' : 'none';
          if (pbVisible) visibleCount++;
        }

        if (noResults) {
          noResults.classList.toggle('hidden', visibleCount > 0);
        }
        if (visibleCountEl) {
          visibleCountEl.textContent = String(visibleCount);
        }
      }

      input.addEventListener('input', applyFilters);

      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          activeFilter = (tab as HTMLElement).dataset.filter || 'all';

          tabs.forEach(t => {
            const isActive = t === tab;
            t.setAttribute('aria-selected', String(isActive));
            (t as HTMLElement).classList.toggle('text-primary', isActive);
            (t as HTMLElement).classList.toggle('border-gray-300', isActive);
            (t as HTMLElement).classList.toggle('text-gray-500', !isActive);
            (t as HTMLElement).classList.toggle('border-transparent', !isActive);
          });

          applyFilters();
        });
      });

      // Set initial active state on "All" tab
      const allTab = document.querySelector('[data-filter="all"]') as HTMLElement;
      if (allTab) {
        allTab.classList.add('text-primary', 'border-gray-300');
        allTab.classList.remove('text-gray-500', 'border-transparent');
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initDirectory);
    } else {
      initDirectory();
    }
    document.addEventListener('astro:page-load', initDirectory);
  </script>
</BaseLayout>
