---
/**
 * /tools - Skill Builder
 * Voice-agent-powered tool that generates .skill files.
 * Density: LOW (hero) -> MED (form) -> MED (voice) -> LOW (email) -> LOW (CTA void)
 */
import BaseLayout from '../layouts/BaseLayout.astro';
import Nav from '../components/Nav.astro';
import Footer from '../components/Footer.astro';
import EmailSignup from '../components/EmailSignup.astro';

const schema = [
  {
    '@type': 'BreadcrumbList',
    'itemListElement': [
      { '@type': 'ListItem', 'position': 1, 'name': 'Home', 'item': 'https://channel47.dev/' },
      { '@type': 'ListItem', 'position': 2, 'name': 'Skill Builder' },
    ],
  },
  {
    '@type': 'WebApplication',
    'name': 'Skill Builder - Channel 47',
    'description': 'Build a custom AI skill through a short voice conversation. Describe your workflow, talk to the builder, get a .skill file.',
    'url': 'https://channel47.dev/tools/',
    'applicationCategory': 'DeveloperApplication',
    'offers': { '@type': 'Offer', 'price': '0', 'priceCurrency': 'USD' },
  },
];
---

<BaseLayout
  title="Skill Builder - Channel 47"
  description="Build a custom AI skill through a short voice conversation. Describe your workflow, talk to the builder, get a .skill file."
  schema={schema}
>
  <Nav />

  <main id="main-content">
    <!-- HERO - LOW density -->
    <section class="pt-28 pb-16" data-section="hero">
      <div class="wrap max-w-[640px]">
        <div class="accent-bar" aria-hidden="true"></div>
        <p class="label mt-5 mb-4">SKILL BUILDER</p>
        <h1
          class="text-[clamp(1.75rem,4vw,2.5rem)] font-semibold tracking-tight leading-[1.1] text-chalk mb-3"
          style="font-family: var(--font-family-display);"
        >
          Build a skill.
        </h1>
        <p class="font-mono text-sm text-dust tracking-wide max-w-[48ch]">
          Describe what you do and the workflow you want to automate. Talk to the builder. Get a .skill file you can
          install in Claude Code or Cowork.
        </p>
      </div>
    </section>

    <!-- FORM - MED density -->
    <section class="pb-12" data-section="builder-form">
      <div class="wrap max-w-[640px]">
        <form id="builder-form" class="flex flex-col gap-5" novalidate>
          <div>
            <label for="field-role" class="font-mono text-[11px] text-stone tracking-wider uppercase mb-2 block">
              What do you do?
            </label>
            <input
              type="text"
              id="field-role"
              name="role"
              placeholder="e.g. Media buyer, Content strategist, Sales ops"
              required
              class="w-full px-4 h-10 font-mono text-sm text-bone bg-soot/80 border border-smoke rounded-tight outline-none transition-[border-color,box-shadow] duration-100 placeholder:text-stone hover:border-ash focus-visible:border-signal focus-visible:shadow-[0_0_0_4px_rgba(245,158,11,0.2)]"
              autocomplete="off"
              spellcheck="false"
            />
          </div>
          <div>
            <label
              for="field-platform"
              class="font-mono text-[11px] text-stone tracking-wider uppercase mb-2 block"
            >
              What tools or platforms do you work with?
            </label>
            <input
              type="text"
              id="field-platform"
              name="platform"
              placeholder="e.g. Google Ads, Salesforce, Notion"
              required
              class="w-full px-4 h-10 font-mono text-sm text-bone bg-soot/80 border border-smoke rounded-tight outline-none transition-[border-color,box-shadow] duration-100 placeholder:text-stone hover:border-ash focus-visible:border-signal focus-visible:shadow-[0_0_0_4px_rgba(245,158,11,0.2)]"
              autocomplete="off"
              spellcheck="false"
            />
          </div>
          <div>
            <label
              for="field-workflow"
              class="font-mono text-[11px] text-stone tracking-wider uppercase mb-2 block"
            >
              Describe the task you want to automate
            </label>
            <textarea
              id="field-workflow"
              name="workflow"
              placeholder="e.g. Every Monday I pull search term reports from Google Ads, classify each term, and build a negative keyword list..."
              required
              rows="4"
              class="w-full px-4 py-3 font-mono text-sm text-bone bg-soot/80 border border-smoke rounded-tight outline-none transition-[border-color,box-shadow] duration-100 placeholder:text-stone hover:border-ash focus-visible:border-signal focus-visible:shadow-[0_0_0_4px_rgba(245,158,11,0.2)] resize-none"
              spellcheck="false"
            ></textarea>
          </div>
          <button
            type="submit"
            class="self-start px-6 h-10 font-mono text-sm font-medium bg-signal text-void rounded-tight hover:brightness-110 transition-[filter] duration-100"
          >
            Talk to the builder
          </button>
        </form>
      </div>
    </section>

    <!-- VOICE - MED density (hidden until form submit) -->
    <section class="pb-12 hidden" data-section="builder-voice" id="voice-section">
      <div class="wrap max-w-[640px]">
        <div class="border border-smoke rounded-tight bg-soot/60 p-8 flex flex-col items-center gap-4">
          <p class="font-mono text-[11px] text-stone tracking-wider uppercase">VOICE BUILDER</p>
          <p class="font-mono text-sm text-dust text-center max-w-[38ch]">
            The builder will ask a few quick questions to refine your skill.
          </p>
          <div id="voice-widget-container">
            <!-- ElevenLabs widget injected here by JS -->
            <elevenlabs-convai
              agent-id={import.meta.env.PUBLIC_ELEVENLABS_AGENT_ID || 'not-configured'}
            ></elevenlabs-convai>
          </div>
          <p id="voice-status" class="font-mono text-[11px] text-stone"></p>
          <button
            id="skip-voice"
            class="mt-4 font-mono text-[11px] text-stone underline underline-offset-2 hover:text-dust transition-colors hidden"
          >
            Done talking? Continue ->
          </button>
        </div>
      </div>
    </section>

    <!-- EMAIL CAPTURE - LOW density (hidden until voice ends) -->
    <section class="py-16 hidden" data-section="builder-email" id="email-section">
      <div class="wrap max-w-[640px] text-center">
        <p class="label mb-4">ALMOST DONE</p>
        <p class="font-mono text-sm text-dust mb-8 max-w-[38ch] mx-auto">
          Your skill is being built. Enter your email to receive the .skill file.
        </p>
        <div data-skill-email>
          <EmailSignup
            placeholder="you@domain.com"
            tag="skill-builder"
            submitText="Send me my skill"
            variant="prominent"
          />
        </div>
      </div>
    </section>

    <!-- CTA VOID - LOW density -->
    <section class="cta" data-section="builder-cta">
      <a class="cta__headline" href="/plugins">Browse plugins</a>
      <a href="/subscribe" class="btn-signal">Get Build Notes</a>
    </section>

    <Footer />
  </main>

  <script is:inline src="https://unpkg.com/@11labs/convai-widget-embed"></script>

  <script>
    function initSkillBuilder() {
      const form = document.getElementById('builder-form') as HTMLFormElement | null;
      const voiceSection = document.getElementById('voice-section');
      const emailSection = document.getElementById('email-section');
      const voiceStatus = document.getElementById('voice-status');
      const widgetContainer = document.getElementById('voice-widget-container');
      const skipButton = document.getElementById('skip-voice');

      if (!form || form.hasAttribute('data-initialized')) return;
      form.setAttribute('data-initialized', 'true');

      let formData: { role: string; platform: string; workflow: string } | null = null;
      const widget = widgetContainer?.querySelector('elevenlabs-convai');

      // v1 delivery path: build from form data until webhook output is persisted server-side.
      function buildSkillFromForm(currentFormData: { role: string; platform: string; workflow: string }): string {
        const safeRole = currentFormData.role || 'Operator';
        const safePlatform = currentFormData.platform || 'General';
        const safeWorkflow = currentFormData.workflow || 'Run workflow steps';
        return `---
name: ${safeRole.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '') || 'custom-skill'}
description: Execute ${safeWorkflow.toLowerCase()} using ${safePlatform}.
---

# Purpose
Automate a repeatable workflow for ${safeRole}.

# When To Use
- Trigger when working in ${safePlatform}
- Trigger when this workflow is requested: ${safeWorkflow}

# Process
1. Gather required context before starting.
2. Execute each workflow step in order.
3. Validate output quality before returning.

# Output
- Return a concise, structured result.
- Include next actions when follow-up is needed.
`;
      }

      function setupEmailDelivery(currentFormData: { role: string; platform: string; workflow: string }) {
        const emailForm = emailSection?.querySelector('[data-skill-email] [data-signup-form]') as HTMLFormElement | null;
        if (!emailForm || emailForm.hasAttribute('data-delivery-initialized')) return;
        emailForm.setAttribute('data-delivery-initialized', 'true');

        emailForm.addEventListener(
          'submit',
          async (e) => {
            e.preventDefault();
            e.stopImmediatePropagation();

            const emailInput = emailForm.querySelector('input[name="email"]') as HTMLInputElement | null;
            const submitButton = emailForm.querySelector('.email-signup__submit') as HTMLButtonElement | null;
            const email = emailInput?.value.trim() || '';
            const resolvedSkillContent = buildSkillFromForm(currentFormData);

            if (!email || !emailInput || !submitButton) {
              emailForm.classList.add('is-error');
              return;
            }

            submitButton.disabled = true;
            emailForm.classList.remove('is-error', 'is-success', 'is-server-error');
            emailForm.classList.add('is-loading');

            try {
              const res = await fetch('/api/deliver-skill', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  email,
                  skill_content: resolvedSkillContent,
                  metadata: {
                    role: currentFormData.role,
                    platform: currentFormData.platform,
                    workflow: currentFormData.workflow,
                    skillName: `${currentFormData.role}-skill`
                  }
                })
              });

              const data = await res.json();
              if (res.ok && data.success && data.skill) {
                const blob = new Blob([data.skill], { type: 'text/markdown' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = data.filename || 'my-skill.skill';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                emailForm.classList.remove('is-loading');
                emailForm.classList.add('is-success');
                emailInput.value = '';
              } else {
                throw new Error('delivery-failed');
              }
            } catch {
              emailForm.classList.remove('is-loading');
              emailForm.classList.add('is-server-error');
            } finally {
              submitButton.disabled = false;
            }
          },
          { capture: true }
        );
      }

      function revealEmailSection() {
        const voiceBox = voiceSection?.querySelector('.border');
        voiceBox?.classList.add('opacity-50');

        emailSection?.classList.remove('hidden');
        emailSection?.scrollIntoView({ behavior: 'smooth', block: 'start' });

        const emailForm = emailSection?.querySelector('[data-signup-form]') as HTMLElement | null;
        if (emailForm && formData) {
          emailForm.dataset.fields = JSON.stringify({
            build_role: formData.role,
            build_tool: formData.platform,
            build_task: formData.workflow,
          });
        }

        if (formData) {
          setupEmailDelivery(formData);
        }
      }

      form.addEventListener('submit', (e) => {
        e.preventDefault();

        const role = (form.querySelector('[name="role"]') as HTMLInputElement | null)?.value.trim() || '';
        const platform = (form.querySelector('[name="platform"]') as HTMLInputElement | null)?.value.trim() || '';
        const workflow = (form.querySelector('[name="workflow"]') as HTMLTextAreaElement | null)?.value.trim() || '';

        if (!role || !platform || !workflow) return;

        formData = { role, platform, workflow };

        form.classList.add('opacity-50', 'pointer-events-none');
        form.querySelector('button[type="submit"]')?.setAttribute('disabled', 'true');

        voiceSection?.classList.remove('hidden');

        if (widgetContainer) {
          const agentId = widgetContainer.querySelector('elevenlabs-convai')?.getAttribute('agent-id');
          if (agentId && agentId !== 'not-configured' && widget) {
            widget.setAttribute(
              'dynamic-variables',
              JSON.stringify({
                user_role: formData.role,
                user_platform: formData.platform,
                user_workflow: formData.workflow,
              })
            );
          }
        }

        voiceSection?.scrollIntoView({ behavior: 'smooth', block: 'start' });

        if (voiceStatus) {
          voiceStatus.textContent = 'Click the widget to start talking.';
        }

        setTimeout(() => {
          skipButton?.classList.remove('hidden');
        }, 15000);
      });

      if (widget) {
        widget.addEventListener('elevenlabs-convai:call-ended', () => {
          revealEmailSection();
        });

        widget.addEventListener('elevenlabs-convai:error', () => {
          if (voiceStatus) {
            voiceStatus.textContent = 'Something went wrong. You can still continue.';
          }
          skipButton?.classList.remove('hidden');
        });
      }

      skipButton?.addEventListener('click', () => {
        revealEmailSection();
      });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initSkillBuilder);
    } else {
      initSkillBuilder();
    }
    document.addEventListener('astro:page-load', initSkillBuilder);
  </script>
</BaseLayout>
