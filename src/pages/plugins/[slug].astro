---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Nav from '../../components/Nav.astro';
import Footer from '../../components/Footer.astro';
import ToolDetail from '../../components/ToolDetail.astro';

export async function getStaticPaths() {
  const tools = await getCollection('tools');
  return tools
    .filter(t => t.data.type === 'plugin')
    .map(tool => ({
      params: { slug: tool.id.split('/').pop()?.replace(/\.md$/, '') },
      props: { tool },
    }));
}

const { tool } = Astro.props;

const allTools = await getCollection('tools');
const related = tool.data.relatedTools.length > 0
  ? allTools.filter(t => tool.data.relatedTools.includes(t.id.split('/').pop()?.replace(/\.md$/, '')!))
  : allTools.filter(t => t.data.type === 'plugin' && t.id !== tool.id).slice(0, 3);

const slug = tool.id.split('/').pop()?.replace(/\.md$/, '');

const schema = [
  {
    '@type': 'SoftwareApplication',
    'name': tool.data.name,
    'description': tool.data.description,
    'applicationCategory': 'Claude Code Plugin',
    'operatingSystem': 'Cross-platform',
    'offers': { '@type': 'Offer', 'price': '0', 'priceCurrency': 'USD' },
    'author': { '@type': 'Person', 'name': tool.data.author || 'Jackson Dean' },
    'url': `https://channel47.dev/plugins/${slug}`,
  },
  {
    '@type': 'BreadcrumbList',
    'itemListElement': [
      { '@type': 'ListItem', 'position': 1, 'name': 'Home', 'item': 'https://channel47.dev/' },
      { '@type': 'ListItem', 'position': 2, 'name': 'Plugins', 'item': 'https://channel47.dev/plugins/' },
      { '@type': 'ListItem', 'position': 3, 'name': tool.data.name },
    ],
  },
];
---

<BaseLayout title={`${tool.data.name} â€” Channel 47`} description={tool.data.description} schema={schema}>
  <Nav />
  <main id="main-content">
    <ToolDetail tool={tool} hubLabel="Plugins" hubHref="/plugins" typeLabel="PLUGIN" related={related} />
    <Footer />
  </main>
</BaseLayout>
