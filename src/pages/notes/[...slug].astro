---
/**
 * Note Article Page
 * Dynamic route for individual Build Notes articles.
 *
 * Density: LOW (hero) → MEDIUM (article body + author) →
 *          LOW/LIGHT (rupture signup) → Footer
 */
import { getCollection, render } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Nav from '../../components/Nav.astro';
import Footer from '../../components/Footer.astro';
import EmailSignup from '../../components/EmailSignup.astro';

export async function getStaticPaths() {
  const notes = await getCollection('notes', ({ data }) => !data.draft);
  return notes.map((note) => ({
    params: { slug: note.id.replace(/\.md$/, '') },
    props: { note },
  }));
}

const { note } = Astro.props;
const { Content } = await render(note);

const { title, description, date, tag } = note.data;

const formatted = date.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

const tagLabel = tag.toUpperCase();

const schema = {
  '@type': 'Article',
  headline: title,
  description,
  datePublished: date.toISOString(),
  author: {
    '@type': 'Person',
    name: 'Jackson Dean',
    url: 'https://x.com/ctrlswing',
  },
  publisher: {
    '@type': 'Organization',
    name: 'Channel 47',
    url: 'https://channel47.dev',
  },
};
---

<BaseLayout
  title={`${title} — Channel 47`}
  description={description}
  schema={schema}
>
  <!-- Reading progress — Signal line, scroll-driven -->
  <div class="reading-progress" aria-hidden="true"></div>

  <main id="main-content" class="pg article-pg">

    <!-- HERO (LOW density) -->
    <section class="article-hero" data-section="hero">
      <Nav currentPath="/notes" />
      <div class="article-hero__content">
        <div class="article-hero__bar" aria-hidden="true"></div>
        <div class="article-hero__meta">
          <span class:list={['article-hero__tag', `article-hero__tag--${tag}`]}>{tagLabel}</span>
          <span class="w-px h-3 bg-gray-300" aria-hidden="true"></span>
          <time class="font-mono text-[11px] text-gray-500 tracking-[0.05em]" datetime={date.toISOString()}>{formatted}</time>
        </div>
        <h1 class="article-hero__title">{title}</h1>
        <p class="article-hero__desc">{description}</p>
      </div>
    </section>

    <!-- ARTICLE (MEDIUM density) -->
    <article class="article-body" data-section="article-body">
      <div class="article-body__inner">
        <div class="article-prose">
          <Content />
        </div>

        <footer class="mt-[clamp(56px,8vh,80px)] pt-[clamp(48px,8vh,72px)] border-t border-gray-200">
          <div class="w-8 h-0.5 bg-amber mb-5" aria-hidden="true"></div>
          <p class="text-base font-semibold text-primary tracking-[-0.01em] mb-1" style="font-family: var(--font-family-heading);">Jackson Dean</p>
          <p class="font-mono text-xs text-gray-500 tracking-[0.02em] mb-6">Media buyer. Building tools from real workflows.</p>
          <a class="font-mono text-[11px] font-semibold tracking-[0.1em] uppercase text-gray-500 hover:text-amber transition-colors duration-100" href="/notes">&larr; All notes</a>
        </footer>
      </div>
    </article>

    <!-- SIGNUP RUPTURE (LOW density, light surface) -->
    <section class="article-signup" data-section="article-signup">
      <div class="max-w-[480px]">
        <div class="article-signup__bar" aria-hidden="true"></div>
        <p class="font-mono text-[11px] uppercase tracking-[0.15em] text-gray-500 mb-3">BUILD NOTES</p>
        <h2 class="text-[clamp(1.5rem,3vw,2rem)] font-semibold tracking-tight leading-[1.1] mb-3" style="font-family: var(--font-family-heading); color: var(--color-light-ink);">Get breakdowns like this weekly.</h2>
        <p class="font-mono text-[11px] tracking-[0.1em] text-gray-500 uppercase mb-5">No spam. Unsubscribe anytime.</p>
        <EmailSignup placeholder="you@domain.com" tag="notes" submitText="Subscribe" />
      </div>
    </section>

    <Footer />
  </main>

  <script>
    import { initPageMotion } from '../../scripts/page-motion';
    initPageMotion();

    // Reading progress bar — JS fallback for browsers without animation-timeline
    function initReadingProgress() {
      const bar = document.querySelector('.reading-progress') as HTMLElement;
      if (!bar) return;

      // Skip if CSS handles it natively
      if (CSS.supports?.('animation-timeline: scroll()')) return;

      function update() {
        const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
        const scrollHeight = document.documentElement.scrollHeight - window.innerHeight;
        const progress = scrollHeight > 0 ? scrollTop / scrollHeight : 0;
        bar.style.transform = `scaleX(${progress})`;
      }

      window.addEventListener('scroll', update, { passive: true });
      update();
    }

    initReadingProgress();
  </script>
</BaseLayout>

<style>
  /* ========================================
   * Article Page — density-mapped layout
   * ======================================== */

  /* ---- Reading Progress Bar ---- */
  .reading-progress {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 2px;
    background: var(--color-amber);
    transform-origin: left;
    transform: scaleX(0);
    z-index: var(--z-max);
    pointer-events: none;
  }

  @supports (animation-timeline: scroll()) {
    .reading-progress {
      animation: reading-progress-fill linear forwards;
      animation-timeline: scroll();
    }

    @keyframes reading-progress-fill {
      from { transform: scaleX(0); }
      to { transform: scaleX(1); }
    }
  }

  /* ---- Article Hero (LOW density) ---- */
  .article-hero {
    min-height: auto;
    display: flex;
    flex-direction: column;
    padding: 0 clamp(24px, 5vw, 64px);
  }

  .article-hero__content {
    padding: clamp(80px, 12vh, 140px) 0 clamp(48px, 8vh, 80px);
    max-width: 672px;
  }

  .article-hero__bar {
    width: 0;
    height: 2px;
    background-color: var(--color-amber);
    margin-bottom: 24px;
  }

  [data-section="hero"].is-visible .article-hero__bar {
    animation: drawH 600ms var(--ease-signature) 200ms forwards;
  }

  .article-hero__meta {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 24px;
    opacity: 0;
  }

  [data-section="hero"].is-visible .article-hero__meta {
    animation: fadeIn 200ms var(--ease-signature) 300ms forwards;
  }

  .article-hero__tag {
    font-family: var(--font-family-mono);
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    padding: 3px 8px;
    border-radius: 2px;
    background: var(--color-gray-100);
    color: var(--color-gray-500);
  }

  .article-hero__tag--breakdown {
    background: var(--amber-dim);
    color: var(--color-amber);
  }

  .article-hero__tag--story,
  .article-hero__tag--guide {
    background: var(--color-gray-100);
    color: var(--color-gray-600);
  }

  .article-hero__title {
    font-family: var(--font-family-heading);
    font-size: clamp(2.25rem, 6vw, 3.5rem);
    line-height: 1;
    letter-spacing: -0.035em;
    font-weight: 600;
    color: var(--color-primary);
    margin-bottom: 20px;
    opacity: 0;
    clip-path: inset(0 50% 0 50%);
  }

  [data-section="hero"].is-visible .article-hero__title {
    animation: clipReveal 600ms var(--ease-signature) 400ms forwards;
  }

  .article-hero__desc {
    font-family: var(--font-family-mono);
    font-size: 14px;
    line-height: 1.7;
    color: var(--color-gray-600);
    max-width: 540px;
    letter-spacing: 0.02em;
    opacity: 0;
  }

  [data-section="hero"].is-visible .article-hero__desc {
    animation: fadeUp 400ms var(--ease-signature) 600ms forwards;
  }

  /* ---- Article Body (MEDIUM density) ---- */
  .article-body {
    padding: 0 clamp(24px, 5vw, 64px);
    border-top: 1px solid var(--color-gray-200);
    opacity: 0;
    transform: translateY(12px);
    transition: opacity 400ms var(--ease-signature),
                transform 400ms var(--ease-signature);
  }

  .article-body.is-visible {
    opacity: 1;
    transform: translateY(0);
  }

  .article-body__inner {
    max-width: 672px;
    padding: clamp(48px, 8vh, 72px) 0 clamp(60px, 10vh, 80px);
  }

  /* ---- Article Prose ---- */
  .article-prose {
    font-family: var(--font-family-mono);
    font-size: 14px;
    line-height: 1.8;
    letter-spacing: 0.02em;
    color: var(--color-gray-700);
  }

  .article-prose :global(h2) {
    font-family: var(--font-family-heading);
    font-size: clamp(1.25rem, 2.5vw, 1.75rem);
    font-weight: 600;
    letter-spacing: -0.02em;
    line-height: 1.15;
    color: var(--color-primary);
    margin-top: 56px;
    margin-bottom: 20px;
    padding-top: 32px;
    border-top: 1px solid var(--color-gray-200);
  }

  .article-prose :global(h2:first-child) {
    margin-top: 0;
    padding-top: 0;
    border-top: none;
  }

  .article-prose :global(h3) {
    font-family: var(--font-family-heading);
    font-size: clamp(1.05rem, 2vw, 1.25rem);
    font-weight: 600;
    letter-spacing: -0.015em;
    color: var(--color-primary);
    margin-top: 40px;
    margin-bottom: 12px;
  }

  .article-prose :global(p) {
    color: var(--color-gray-700);
    margin-bottom: 24px;
  }

  .article-prose :global(p:last-child) {
    margin-bottom: 0;
  }

  .article-prose :global(strong) {
    font-weight: 600;
    color: var(--color-primary);
  }

  .article-prose :global(a) {
    color: var(--color-amber);
    text-decoration: underline;
    text-decoration-thickness: 1px;
    text-underline-offset: 3px;
    transition: color 100ms var(--ease-signature);
  }

  .article-prose :global(a:hover) {
    color: #D97706;
  }

  .article-prose :global(blockquote) {
    border-left: 2px solid var(--color-amber);
    padding: 4px 0 4px 24px;
    margin: 32px 0;
  }

  .article-prose :global(blockquote p) {
    font-family: var(--font-family-editorial);
    font-size: 17px;
    font-style: italic;
    line-height: 1.65;
    letter-spacing: 0;
    color: var(--color-gray-600);
  }

  .article-prose :global(ul),
  .article-prose :global(ol) {
    padding-left: 24px;
    margin-bottom: 24px;
  }

  .article-prose :global(li) {
    margin-bottom: 10px;
    color: var(--color-gray-700);
  }

  .article-prose :global(li:last-child) {
    margin-bottom: 0;
  }

  .article-prose :global(li::marker) {
    color: var(--color-gray-500);
  }

  .article-prose :global(code) {
    font-family: var(--font-family-mono);
    font-size: 0.9em;
    background: var(--color-gray-100);
    padding: 2px 6px;
    border-radius: 2px;
    color: var(--color-primary);
  }

  .article-prose :global(pre) {
    background: var(--color-gray-100);
    border: 1px solid var(--color-gray-200);
    border-radius: 2px;
    padding: 20px 24px;
    margin: 32px 0;
    overflow-x: auto;
  }

  .article-prose :global(pre code) {
    background: transparent;
    padding: 0;
    font-size: 13px;
    line-height: 1.6;
    color: var(--color-gray-700);
  }

  .article-prose :global(hr) {
    border: none;
    height: 1px;
    background: var(--color-gray-200);
    margin: 48px 0;
  }

  /* Inline CTA Aside */
  .article-prose :global(.note-cta) {
    border-left: 2px solid var(--color-amber);
    padding: 16px 0 16px 24px;
    margin: 48px 0;
  }

  .article-prose :global(.note-cta__label) {
    font-family: var(--font-family-mono);
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--color-gray-500);
    margin-bottom: 6px;
  }

  .article-prose :global(.note-cta__text) {
    font-family: var(--font-family-mono);
    font-size: 13px;
    letter-spacing: 0.02em;
    color: var(--color-gray-600);
    margin-bottom: 0;
  }

  .article-prose :global(.note-cta__text a) {
    color: var(--color-amber);
    text-decoration: underline;
    text-decoration-thickness: 1px;
    text-underline-offset: 3px;
    font-weight: 500;
    transition: color 100ms var(--ease-signature);
  }

  .article-prose :global(.note-cta__text a:hover) {
    color: #D97706;
  }

  /* ---- Signup Rupture (LOW density, light surface) ---- */
  .article-signup {
    background: var(--color-light-canvas);
    color: var(--color-light-ink);
    padding: clamp(80px, 14vh, 140px) clamp(24px, 5vw, 64px);
    opacity: 0;
    filter: blur(4px);
    transform: translateY(12px);
    transition: opacity 600ms var(--ease-signature),
                filter 600ms var(--ease-signature),
                transform 600ms var(--ease-signature);
  }

  .article-signup.is-visible {
    opacity: 1;
    filter: blur(0);
    transform: translateY(0);
  }

  .article-signup__bar {
    width: 0;
    height: 2px;
    background-color: var(--color-amber);
    margin-bottom: 24px;
  }

  .article-signup.is-visible .article-signup__bar {
    animation: drawH 400ms var(--ease-signature) 200ms forwards;
  }

  /* EmailSignup overrides for light surface */
  .article-signup :global(.email-signup__input) {
    background: var(--color-light-paper);
    border-color: var(--color-light-border);
    color: var(--color-light-ink);
  }

  .article-signup :global(.email-signup__input::placeholder) {
    color: var(--color-gray-500);
  }

  .article-signup :global(.email-signup__input:focus) {
    background: #fff;
    border-color: var(--color-amber);
    box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.15);
  }

  /* ---- Reduced Motion ---- */
  @media (prefers-reduced-motion: reduce) {
    .reading-progress {
      display: none;
    }

    .article-hero__meta,
    .article-hero__title,
    .article-hero__desc {
      opacity: 1 !important;
      clip-path: none !important;
    }

    .article-hero__bar,
    .article-signup__bar {
      width: 40px !important;
    }

    .article-signup {
      filter: none !important;
    }
  }

  /* ---- Responsive ---- */
  @media (max-width: 640px) {
    .article-hero__content {
      padding-top: clamp(60px, 10vh, 80px);
    }

    .article-hero__title {
      font-size: clamp(1.75rem, 8vw, 2.25rem);
    }
  }
</style>
