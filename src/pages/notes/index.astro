---
/**
 * Notes Hub — Build Notes index page.
 *
 * Density: LOW (hero) → MEDIUM (content grid) → MEDIUM (signup) → LOW (cta void)
 */
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Nav from '../../components/Nav.astro';
import Footer from '../../components/Footer.astro';
import ContentCard from '../../components/ContentCard.astro';
import EmailSignup from '../../components/EmailSignup.astro';

const notes = (await getCollection('notes', ({ data }) => !data.draft))
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

const tags = ['all', 'breakdown', 'story', 'guide'] as const;
---

<BaseLayout
  title="Build Notes — Channel 47"
  description="Weekly breakdowns from the Channel 47 ecosystem. Stories, guides, and skill teardowns from building AI plugins for real work."
>
  <main class="pg">

    <!-- =======================================
         HERO (LOW density)
         ======================================= -->
    <section class="hero" data-section="hero">
      <Nav currentPath="/notes" />
      <div class="hero__content">
        <div class="hero__bar" aria-hidden="true"></div>
        <p class="label">FROM THE WORKSHOP</p>
        <h1 class="hero__headline">Build Notes</h1>
        <p class="hero__sub">
          Stories, guides, and breakdowns from building AI plugins for real work.
          Every week, one skill from the ecosystem. Taken apart.
        </p>
      </div>
    </section>

    <!-- =======================================
         CONTENT GRID (MEDIUM density)
         ======================================= -->
    <section class="notes-grid" data-section="notes-grid">
      <div class="notes-grid__controls">
        <div class="notes-grid__tags" data-tag-filter>
          {tags.map((t) => (
            <button
              class:list={['notes-grid__tag', t === 'all' && 'is-active']}
              data-filter={t}
            >
              {t.toUpperCase()}
            </button>
          ))}
        </div>
      </div>
      <div class="notes-grid__list">
        {notes.map((note, i) => (
          <div data-animate="fade-up" data-stagger={String(Math.min(i + 1, 6))} data-tag-value={note.data.tag}>
            <ContentCard
              title={note.data.title}
              description={note.data.description}
              date={note.data.date}
              tag={note.data.tag}
              slug={note.id.replace(/\.md$/, '')}
            />
          </div>
        ))}
      </div>
      {notes.length === 0 && (
        <p class="notes-grid__empty">First notes are coming soon.</p>
      )}
    </section>

    <!-- =======================================
         SIGNUP (MEDIUM density)
         ======================================= -->
    <section class="notes-signup" data-section="notes-signup">
      <div class="notes-signup__content">
        <p class="label">BUILD NOTES</p>
        <h2 class="notes-signup__title">Get these in your inbox.</h2>
        <p class="notes-signup__micro">No spam. Unsubscribe anytime.</p>
        <EmailSignup placeholder="you@domain.com" tag="notes" submitText="Subscribe" />
      </div>
    </section>

    <!-- =======================================
         CTA VOID (LOW density)
         ======================================= -->
    <section class="cta" data-section="cta">
      <p class="label">TRANSMITTING</p>
      <a class="cta__action" href="/build?start">Build your first skill</a>
    </section>

    <Footer />
  </main>

  <script>
    import { initPageMotion } from '../../scripts/page-motion';
    initPageMotion();
  </script>

  <!-- Tag filter (minimal JS toggle) -->
  <script>
    function initTagFilter() {
      const container = document.querySelector('[data-tag-filter]');
      if (!container || container.hasAttribute('data-initialized')) return;
      container.setAttribute('data-initialized', 'true');

      const buttons = container.querySelectorAll('[data-filter]');
      const items = document.querySelectorAll('[data-tag-value]');

      buttons.forEach((btn) => {
        btn.addEventListener('click', () => {
          const filter = (btn as HTMLElement).dataset.filter;

          buttons.forEach((b) => b.classList.remove('is-active'));
          btn.classList.add('is-active');

          items.forEach((item) => {
            const el = item as HTMLElement;
            if (filter === 'all' || el.dataset.tagValue === filter) {
              el.style.display = '';
            } else {
              el.style.display = 'none';
            }
          });
        });
      });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initTagFilter);
    } else {
      initTagFilter();
    }

    document.addEventListener('astro:page-load', initTagFilter);
  </script>
</BaseLayout>

<style is:global>
  @import '../../styles/sections.css';
</style>

<style>
  /* ---- Notes Grid (MEDIUM density) ---- */
  .notes-grid {
    padding: clamp(40px, 6vh, 60px) clamp(24px, 5vw, 64px);
    opacity: 0;
    transform: translateY(12px);
    transition: opacity 400ms var(--ease-out),
                transform 400ms var(--ease-out);
  }

  .notes-grid.is-visible {
    opacity: 1;
    transform: translateY(0);
  }

  .notes-grid__controls {
    margin-bottom: 24px;
  }

  .notes-grid__tags {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .notes-grid__tag {
    font-family: var(--font-mono);
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    padding: 6px 12px;
    border-radius: 2px;
    background: transparent;
    color: var(--color-fg-muted);
    border: 1px solid var(--color-border);
    cursor: pointer;
    transition:
      color var(--duration-fast) var(--ease-out),
      border-color var(--duration-fast) var(--ease-out),
      background-color var(--duration-fast) var(--ease-out);
  }

  .notes-grid__tag:hover {
    color: var(--color-fg);
    border-color: var(--color-fg-muted);
  }

  .notes-grid__tag.is-active {
    color: var(--color-accent);
    border-color: var(--color-accent);
    background: var(--color-accent-subtle);
  }

  .notes-grid__list {
    max-width: 672px;
  }

  .notes-grid__empty {
    font-family: var(--font-mono);
    font-size: 14px;
    color: var(--color-fg-muted);
    padding: 40px 0;
  }

  /* ---- Notes Signup (MEDIUM density) ---- */
  .notes-signup {
    padding: clamp(60px, 10vh, 100px) clamp(24px, 5vw, 64px);
    border-top: 1px solid var(--color-border);
    opacity: 0;
    transform: translateY(12px);
    transition: opacity 400ms var(--ease-out),
                transform 400ms var(--ease-out);
  }

  .notes-signup.is-visible {
    opacity: 1;
    transform: translateY(0);
  }

  .notes-signup__content .label {
    margin-bottom: 8px;
  }

  .notes-signup__title {
    font-family: var(--font-display);
    font-size: clamp(1.5rem, 3vw, 2rem);
    font-weight: 600;
    letter-spacing: -0.03em;
    line-height: 1.1;
    color: var(--color-fg-emphasis);
    margin-bottom: 12px;
  }

  .notes-signup__micro {
    font-family: var(--font-mono);
    font-size: 11px;
    letter-spacing: 0.1em;
    color: var(--color-fg-muted);
    margin-bottom: 16px;
    text-transform: uppercase;
  }

  /* ---- CTA Action (reuse from sections.css, page-specific) ---- */
  .cta__action {
    font-family: var(--font-display);
    font-size: clamp(1.5rem, 4vw, 2.5rem);
    font-weight: 500;
    color: var(--color-fg-emphasis);
    text-decoration: none;
    position: relative;
    display: inline-block;
    margin-bottom: 40px;
    transition: color 150ms var(--ease-out);
  }

  .cta__action::after {
    content: '';
    position: absolute;
    left: 0;
    bottom: -6px;
    width: 100%;
    height: 2px;
    background: var(--color-accent);
    transform-origin: left;
    transition: transform 250ms var(--ease-out);
  }

  .cta__action:hover {
    color: var(--color-accent);
  }

  .cta__action:hover::after {
    transform: scaleX(0);
    transform-origin: right;
  }

  .cta__action:focus-visible {
    outline: 2px solid var(--color-accent);
    outline-offset: 4px;
  }

  /* ---- Reduced Motion ---- */
  @media (prefers-reduced-motion: reduce) {
    .notes-grid__tag {
      transition: none;
    }

    .cta__action,
    .cta__action::after {
      transition: none;
    }
  }
</style>
