---
/**
 * /build — Skill Builder
 * Interactive funnel: 3 questions → personalized Claude prompt.
 * Homepage links here with ?start to skip landing and enter funnel directly.
 */
import FormPageLayout from '../layouts/FormPageLayout.astro';

const schema = {
  '@type': 'WebApplication',
  'name': 'AI Skill Builder — Channel 47',
  'url': 'https://channel47.dev/build',
  'applicationCategory': 'EducationalApplication',
  'operatingSystem': 'Web',
  'description': 'Build a personalized AI skill in five minutes. Three questions, then Claude walks you through the build step by step.',
  'offers': {
    '@type': 'Offer',
    'price': '0',
    'priceCurrency': 'USD',
  },
};
---

<FormPageLayout
  title="Build Your First AI Skill — Channel47"
  description="Build a personalized AI skill in five minutes. Three questions, then Claude walks you through the build step by step."
  class="build"
  schema={schema}
>

    <!-- Hide page instantly when ?start is present to prevent flash of landing step -->
    <script is:inline>
      if (new URLSearchParams(window.location.search).has('start')) {
        document.documentElement.classList.add('build--skip-landing');
      }
    </script>

    <!-- ── PROGRESS (hidden on landing, visible during funnel) ── -->
    <div class="build__progress is-hidden" aria-hidden="true">
      <div class="build__progress-bar" id="progressBar"></div>
    </div>

    <!-- ═══════════════════════════════════════════
         LANDING: Hero → Start Funnel
         ═══════════════════════════════════════════ -->
    <section class="fp-step build__step--landing is-active" data-step="0">

      <!-- ── ZONE 1: Hero — Build Your Own (HIGH density) ── -->
      <div class="build__hero">
        <div class="fp-bar fp-bar--entry" aria-hidden="true"></div>
        <p class="fp-label fp-label--accent">SKILL BUILDER</p>
        <h1 class="fp-heading">Build your first skill in five minutes.</h1>
        <p class="fp-body">
          Three questions. You get a Claude prompt built around your workflow. No code. No setup.
        </p>
        <button class="fp-btn fp-btn--primary fp-btn--lg" id="startFunnel">
          Start building <span class="fp-arrow" aria-hidden="true">-&gt;</span>
        </button>
      </div>
    </section>

    <!-- ═══════════════════════════════════════════
         FUNNEL STEP 1: Role (broadened for audience)
         ═══════════════════════════════════════════ -->
    <section class="fp-step" data-step="1">
      <button class="fp-back" data-back aria-label="Go back">&lt;- Back</button>
      <p class="fp-label fp-label--accent">STEP 1 OF 3</p>
      <h1 class="fp-heading">What best describes you?</h1>
      <div class="fp-options" data-field="role">
        <button class="fp-option" data-value="Entrepreneur / founder">Entrepreneur / founder</button>
        <button class="fp-option" data-value="Marketer / agency">Marketer / agency</button>
        <button class="fp-option" data-value="Small business owner">Small business owner</button>
        <button class="fp-option" data-value="Content creator">Content creator</button>
        <button class="fp-option" data-value="Builder / developer">Builder / developer</button>
        <button class="fp-option" data-value="other">Other</button>
      </div>
      <div class="fp-other" data-other="role" hidden>
        <input
          type="text"
          class="fp-input"
          placeholder="What's your role?"
          maxlength="100"
          data-other-input="role"
        />
        <button class="build__next" data-other-submit="role">
          Next <span class="fp-arrow" aria-hidden="true">-&gt;</span>
        </button>
      </div>
    </section>

    <!-- ── FUNNEL STEP 2: Task (broadened) ── -->
    <section class="fp-step" data-step="2">
      <button class="fp-back" data-back aria-label="Go back">&lt;- Back</button>
      <p class="fp-label fp-label--accent">STEP 2 OF 3</p>
      <h1 class="fp-heading fp-heading--sm">What eats your time every week?</h1>
      <div class="fp-options" data-field="task">
        <button class="fp-option" data-value="Write content or copy">Write content or copy</button>
        <button class="fp-option" data-value="Manage projects or clients">Manage projects or clients</button>
        <button class="fp-option" data-value="Run ads or campaigns">Run ads or campaigns</button>
        <button class="fp-option" data-value="Research or analyze data">Research or analyze data</button>
        <button class="fp-option" data-value="Build workflows or automations">Build workflows or automations</button>
        <button class="fp-option" data-value="other">Other</button>
      </div>
      <div class="fp-other" data-other="task" hidden>
        <input
          type="text"
          class="fp-input"
          placeholder="What task eats your time?"
          maxlength="200"
          data-other-input="task"
        />
        <button class="build__next" data-other-submit="task">
          Next <span class="fp-arrow" aria-hidden="true">-&gt;</span>
        </button>
      </div>
    </section>

    <!-- ── FUNNEL STEP 3: Tool (broadened) ── -->
    <section class="fp-step" data-step="3">
      <button class="fp-back" data-back aria-label="Go back">&lt;- Back</button>
      <p class="fp-label fp-label--accent">STEP 3 OF 3</p>
      <h1 class="fp-heading">What's your main tool?</h1>
      <div class="fp-options" data-field="tool">
        <button class="fp-option" data-value="Google Workspace (Docs, Sheets)">Google Workspace (Docs, Sheets)</button>
        <button class="fp-option" data-value="Notion / project management">Notion / project management</button>
        <button class="fp-option" data-value="Ad platforms (Google, Meta)">Ad platforms (Google, Meta)</button>
        <button class="fp-option" data-value="Email / CRM (HubSpot, Mailchimp)">Email / CRM (HubSpot, Mailchimp)</button>
        <button class="fp-option" data-value="Code editors (VS Code, Cursor)">Code editors (VS Code, Cursor)</button>
        <button class="fp-option" data-value="other">Other</button>
      </div>
      <div class="fp-other" data-other="tool" hidden>
        <input
          type="text"
          class="fp-input"
          placeholder="What tool do you use most?"
          maxlength="100"
          data-other-input="tool"
        />
        <button class="build__next" data-other-submit="tool">
          Next <span class="fp-arrow" aria-hidden="true">-&gt;</span>
        </button>
      </div>
    </section>

    <!-- ═══════════════════════════════════════════
         FUNNEL RESULT: Claude link + Email capture
         ═══════════════════════════════════════════ -->
    <section class="fp-step build__step--result" data-step="4">
      <div class="fp-bar" aria-hidden="true"></div>
      <p class="fp-label fp-label--accent">YOUR SKILL PROMPT</p>
      <h1 class="fp-heading">Ready to build.</h1>
      <p class="fp-body">
        A prompt built from your answers. Claude walks you through the build step by step.
      </p>
      <a
        id="claudeLink"
        href="#"
        target="_blank"
        rel="noopener"
        class="fp-btn fp-btn--primary fp-btn--lg"
      >
        Open in Claude <span class="fp-arrow" aria-hidden="true">-&gt;</span>
      </a>

      <p class="build__result-subscribe">
        I break down a new skill every week. <a href="/subscribe" class="build__result-subscribe-link">Get the build notes</a>
      </p>

      <p class="build__result-hire">
        Want me to build it instead? <a href="/hire" class="build__result-hire-link">Tell me the workflow</a>
      </p>

      <button class="fp-back build__back--result" data-back-to-landing aria-label="Back to skills">
        &lt;- Back to skills
      </button>
    </section>

</FormPageLayout>

<!-- ── FORM LOGIC ── -->
<script>
  const answers: Record<string, string> = {};
  let currentStep = 0; // 0 = landing, 1-3 = funnel, 4 = result
  const totalFunnelSteps = 3;

  function updateProgress() {
    const bar = document.getElementById('progressBar');
    const progressEl = document.querySelector('.build__progress');

    if (currentStep === 0) {
      // Hide progress bar on landing
      progressEl?.classList.add('is-hidden');
      return;
    }

    progressEl?.classList.remove('is-hidden');
    const pct = currentStep === 4 ? 100 : ((currentStep - 1) / totalFunnelSteps) * 100;
    if (bar) {
      bar.style.width = `${pct}%`;
    }
  }

  function goToStep(step: number) {
    const current = document.querySelector('.fp-step.is-active');
    const next = document.querySelector(`[data-step="${step}"]`);
    if (!current || !next || current === next) return;

    current.classList.add('is-leaving');

    setTimeout(() => {
      current.classList.remove('is-active', 'is-leaving');
      next.classList.add('is-active');
      currentStep = step;
      updateProgress();

      // Auto-focus text input if "other" is showing
      const otherInput = next.querySelector('.fp-input:not([type="email"])') as HTMLInputElement;
      if (otherInput && !otherInput.closest('[hidden]')) {
        otherInput.focus();
      }

      // On result step, build the claude.ai link
      if (step === 4) {
        buildClaudeLink();
      }

      // Scroll to top when returning to landing or reaching result
      if (step === 0 || step === 4) {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    }, 250);
  }

  function buildClaudeLink() {
    const role = answers.role || 'professional';
    const task = answers.task || 'repetitive tasks';
    const tool = answers.tool || 'various tools';

    const prompt = `I'm a ${role.toLowerCase()}. Every week I ${task.toLowerCase()}, and it takes too much of my time. My main tool is ${tool}. Help me build a Claude skill (a SKILL.md file for Claude's skill system) that automates or accelerates this. Walk me through it step by step. Start by asking 2-3 clarifying questions about my specific workflow, then build the complete skill.`;

    const link = document.getElementById('claudeLink') as HTMLAnchorElement;
    if (link) {
      link.href = `https://claude.ai/new?q=${encodeURIComponent(prompt)}`;
    }

    // Update subscribe link with funnel context
    const subscribeLink = document.querySelector('.build__result-subscribe-link') as HTMLAnchorElement;
    if (subscribeLink) {
      const params = new URLSearchParams({ ref: 'build', role, task, tool });
      subscribeLink.href = `/subscribe?${params.toString()}`;
    }
  }

  // ── Start funnel button (hero CTA) ──
  document.getElementById('startFunnel')?.addEventListener('click', () => {
    goToStep(1);
  });

  // ── Handle option clicks ──
  document.querySelectorAll('.fp-option').forEach(btn => {
    btn.addEventListener('click', () => {
      const field = btn.closest('.fp-options')?.getAttribute('data-field');
      const value = (btn as HTMLElement).dataset.value;
      if (!field || !value) return;

      if (value === 'other') {
        // Show the "other" text input
        const otherDiv = document.querySelector(`[data-other="${field}"]`) as HTMLElement;
        const optionsDiv = btn.closest('.fp-options') as HTMLElement;
        if (otherDiv && optionsDiv) {
          optionsDiv.hidden = true;
          otherDiv.hidden = false;
          const input = otherDiv.querySelector('input') as HTMLInputElement;
          if (input) input.focus();
        }
        return;
      }

      answers[field] = value;
      goToStep(currentStep + 1);
    });
  });

  // ── Handle "other" submit buttons ──
  document.querySelectorAll('[data-other-submit]').forEach(btn => {
    btn.addEventListener('click', () => {
      const field = (btn as HTMLElement).dataset.otherSubmit;
      if (!field) return;
      const input = document.querySelector(`[data-other-input="${field}"]`) as HTMLInputElement;
      if (!input) return;
      const val = input.value.trim();
      if (!val) {
        input.focus();
        return;
      }
      answers[field] = val;
      goToStep(currentStep + 1);
    });
  });

  // ── Handle Enter key on "other" inputs ──
  document.querySelectorAll('.fp-other input').forEach(input => {
    input.addEventListener('keydown', (e) => {
      if ((e as KeyboardEvent).key === 'Enter') {
        e.preventDefault();
        const field = input.closest('.fp-other')?.getAttribute('data-other');
        if (!field) return;
        const btn = document.querySelector(`[data-other-submit="${field}"]`) as HTMLButtonElement;
        if (btn) btn.click();
      }
    });
  });

  // ── Handle back buttons (funnel steps) ──
  document.querySelectorAll('[data-back]').forEach(btn => {
    btn.addEventListener('click', () => {
      if (currentStep > 0) {
        // Reset "other" state for the current step before going back
        const currentStepEl = document.querySelector(`[data-step="${currentStep}"]`);
        if (currentStepEl) {
          const otherDiv = currentStepEl.querySelector('.fp-other') as HTMLElement;
          const optionsDiv = currentStepEl.querySelector('.fp-options') as HTMLElement;
          if (otherDiv && optionsDiv) {
            otherDiv.hidden = true;
            optionsDiv.hidden = false;
            const input = otherDiv.querySelector('input') as HTMLInputElement;
            if (input) input.value = '';
          }
        }
        goToStep(currentStep - 1);
      }
    });
  });

  // ── Handle "back to landing" from result page ──
  document.querySelector('[data-back-to-landing]')?.addEventListener('click', () => {
    goToStep(0);
  });

  // Init progress bar
  updateProgress();

  // Auto-start funnel if ?start param is present (e.g. from homepage CTA)
  if (new URLSearchParams(window.location.search).has('start')) {
    // Skip the transition animation — just swap steps instantly
    const landing = document.querySelector('[data-step="0"]');
    const step1 = document.querySelector('[data-step="1"]');
    if (landing && step1) {
      landing.classList.remove('is-active');
      step1.classList.add('is-active');
      currentStep = 1;
      updateProgress();
    }
    // Reveal the page now that the right step is showing
    document.documentElement.classList.remove('build--skip-landing');
  }

  // Reduced motion: disable transitions
  if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
    document.documentElement.classList.add('reduce-motion');
  }
</script>

<style>
  /* ── Hide page until correct step is shown (prevents flash of landing on ?start) ── */
  :global(.build--skip-landing) body {
    visibility: hidden;
  }

  /* ── Build page overrides ── */
  .build {
    justify-content: center;
  }

  /* ── Progress bar ── */
  .build__progress {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--color-bg-elevated);
    z-index: var(--z-fixed);
    opacity: 1;
    transition: opacity var(--duration-normal) var(--ease-out);
  }

  .build__progress.is-hidden {
    opacity: 0;
    pointer-events: none;
  }

  .build__progress-bar {
    height: 100%;
    width: 0;
    background: var(--color-accent);
    box-shadow: 0 0 8px var(--color-accent-glow);
    transition: width 400ms var(--ease-out);
    animation: breathe-progress 5s ease-in-out infinite;
  }

  @keyframes breathe-progress {
    0%, 100% { box-shadow: 0 0 4px var(--color-accent-subtle); }
    50% { box-shadow: 0 0 12px var(--color-accent-glow); }
  }

  /* ── Landing page layout ── */
  .build__step--landing {
    padding-top: var(--space-16);
    justify-content: flex-start;
    margin: 0;
  }

  /* ── Result layout ── */
  .build__step--result {
    padding-top: var(--space-16);
    justify-content: flex-start;
    margin: 0;
  }

  /* ══════════════════════════════════════
     ZONE 1: Hero — Build Your Own
     ══════════════════════════════════════ */
  .build__hero {
    width: 100%;
    padding-bottom: var(--space-12);
  }

  .build__hero :global(.fp-body) {
    margin-bottom: var(--space-6);
  }

  /* ── Next button (funnel-specific) ── */
  .build__next {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    width: fit-content;
    padding: var(--space-3) var(--space-5);
    font-family: var(--font-mono);
    font-size: var(--text-2xs);
    font-weight: var(--font-semibold);
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--color-fg-inverse);
    background: var(--color-accent);
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition:
      background-color 150ms var(--ease-sharp),
      color 100ms var(--ease-sharp),
      box-shadow 200ms var(--ease-out),
      transform 200ms var(--ease-out);
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
  }

  .build__next:hover {
    background: var(--color-fg);
    color: var(--color-bg);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    transform: translateY(-1px);
  }

  .build__next:active {
    transform: translateY(0);
    box-shadow: none;
    transition-duration: 50ms;
  }

  .build__next:hover :global(.fp-arrow) {
    transform: translateX(4px);
  }

  /* ── Post-funnel subscribe link (secondary, non-competing) ── */
  .build__result-subscribe {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    line-height: var(--leading-relaxed);
    color: var(--color-fg-muted);
    margin-top: var(--space-10);
    padding-top: var(--space-6);
    border-top: 1px solid var(--color-border);
    width: 100%;
  }

  .build__result-subscribe-link {
    color: var(--color-accent);
    text-decoration: underline;
    text-underline-offset: 3px;
    text-decoration-thickness: 1px;
    transition: color var(--duration-fast);
  }

  .build__result-subscribe-link:hover {
    color: var(--color-fg);
  }

  .build__result-hire {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    line-height: var(--leading-relaxed);
    color: var(--color-fg-muted);
    margin-top: var(--space-3);
    width: 100%;
  }

  .build__result-hire-link {
    color: var(--color-accent);
    text-decoration: underline;
    text-underline-offset: 3px;
    text-decoration-thickness: 1px;
    transition: color var(--duration-fast);
  }

  .build__result-hire-link:hover {
    color: var(--color-fg);
  }

  /* ── Back to skills variant ── */
  .build__back--result {
    margin-top: var(--space-6);
    margin-bottom: 0;
  }

  /* ── Reduced Motion ── */
  @media (prefers-reduced-motion: reduce) {
    .build__progress,
    .build__progress-bar {
      transition: none;
      animation: none;
    }

    .build__next {
      transition: none;
    }

    .build__next:hover {
      transform: none;
    }
  }

  /* ── Mobile: compensate increased page padding ── */
  @media (max-width: 767px) {
    .build__step--landing,
    .build__step--result {
      padding-top: var(--space-6);
    }
  }

  /* ── Touch feedback ── */
  @media (hover: none) {
    .build__next:active {
      transform: scale(0.97);
    }
  }
</style>
